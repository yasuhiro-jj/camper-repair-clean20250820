<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>キャンピングカー修理専門AIチャット</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      h1 {
        text-align: center;
        color: white;
        margin-bottom: 10px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      }

      .subtitle {
        text-align: center;
        color: rgba(255,255,255,0.9);
        margin-bottom: 30px;
        font-size: 1.1em;
      }

      .chat-header {
        background: rgba(255,255,255,0.95);
        padding: 15px 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      }

      .new-chat-btn {
        background: linear-gradient(45deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .new-chat-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52,152,219,0.4);
      }

      .chat-info {
        color: #666;
        font-weight: bold;
      }

      .chat-container {
        flex: 1;
        background: rgba(255,255,255,0.95);
        border-radius: 15px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        overflow: hidden;
      }

      .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        max-height: 60vh;
      }

      .message {
        margin-bottom: 20px;
        display: flex;
        align-items: flex-start;
      }

      .message.user {
        justify-content: flex-end;
      }

      .message.ai {
        justify-content: flex-start;
      }

      .message-content {
        max-width: 70%;
        padding: 15px 20px;
        border-radius: 20px;
        word-wrap: break-word;
      }

      .message.user .message-content {
        background: linear-gradient(45deg, #3498db, #2980b9);
        color: white;
        border-bottom-right-radius: 5px;
      }

      .message.ai .message-content {
        background: #f8f9fa;
        color: #333;
        border: 1px solid #e9ecef;
        border-bottom-left-radius: 5px;
      }

      .message-time {
        font-size: 0.8em;
        color: #999;
        margin-top: 5px;
        text-align: right;
      }

      .chat-input-area {
        padding: 20px;
        border-top: 1px solid #e9ecef;
        background: #f8f9fa;
      }

      .chat-form {
        margin-bottom: 15px;
      }

      .input-group {
        display: flex;
        gap: 10px;
      }

      .chat-input {
        flex: 1;
        padding: 15px 20px;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        font-size: 16px;
        outline: none;
        transition: border-color 0.3s ease;
      }

      .chat-input:focus {
        border-color: #3498db;
      }

      .send-btn {
        background: linear-gradient(45deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 15px 20px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        transition: all 0.3s ease;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .send-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 5px 15px rgba(52,152,219,0.4);
      }

      .quick-questions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 15px;
      }

      .quick-btn {
        background: #f39c12;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .quick-btn:hover {
        background: #e67e22;
        transform: translateY(-2px);
      }

      .loading {
        text-align: center;
        color: #666;
        font-style: italic;
        padding: 20px;
      }

      .links-section {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid #3498db;
      }

      .links-section h3 {
        color: #2c3e50;
        margin-bottom: 10px;
      }

      .links-section ul {
        list-style: none;
        padding: 0;
      }

      .links-section li {
        margin-bottom: 8px;
        padding: 8px 12px;
        background: white;
        border-radius: 5px;
        border-left: 3px solid #3498db;
      }

      .links-section a {
        color: #3498db;
        text-decoration: none;
        font-weight: 500;
      }

      .links-section a:hover {
        text-decoration: underline;
      }

      /* サポートセンター情報のスタイル */
      .support-center-info {
        background: rgba(255,255,255,0.95);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-left: 5px solid #e74c3c;
      }

      .support-center-info h2 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 1.5em;
        text-align: center;
      }

      .support-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
      }

      .info-item {
        background: #f8f9fa;
        padding: 12px 15px;
        border-radius: 8px;
        border-left: 3px solid #3498db;
        font-size: 0.95em;
      }

      .info-item strong {
        color: #2c3e50;
        display: inline-block;
        margin-right: 8px;
      }

      .contact-form-btn {
        color: #3498db;
        text-decoration: none;
        font-weight: bold;
        padding: 8px 15px;
        background: linear-gradient(45deg, #f39c12, #e67e22);
        color: white;
        border-radius: 8px;
        display: inline-block;
        margin-left: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(243, 156, 18, 0.3);
      }

      .contact-form-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(243, 156, 18, 0.4);
        background: linear-gradient(45deg, #e67e22, #d35400);
      }

      /* 関連ブログセクションのスタイル */
      .related-blogs {
        background: rgba(255,255,255,0.95);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-left: 5px solid #27ae60;
        display: none;
      }

      .related-blogs h3 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 1.3em;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .blog-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }

      .blog-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        border-left: 4px solid #27ae60;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .blog-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(39,174,96,0.2);
      }

      .blog-title {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 8px;
        font-size: 1.1em;
      }

      .blog-excerpt {
        color: #666;
        font-size: 0.9em;
        line-height: 1.4;
        margin-bottom: 10px;
      }

      .blog-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8em;
        color: #999;
      }

      .blog-tags {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
      }

      .blog-tag {
        background: #27ae60;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.7em;
      }

      /* スクロールバーのカスタマイズ */
      .chat-messages::-webkit-scrollbar {
        width: 8px;
      }

      .chat-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .chat-messages::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }

      .chat-messages::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }

      /* レスポンシブデザイン */
      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        h1 {
          font-size: 2em;
        }

        .chat-header {
          flex-direction: column;
          gap: 10px;
        }

        .message-content {
          max-width: 85%;
        }

        .quick-questions {
          justify-content: center;
        }

        .support-details {
          grid-template-columns: 1fr;
        }

                 .support-center-info h2 {
           font-size: 1.3em;
         }

         .blog-grid {
           grid-template-columns: 1fr;
         }

         .blog-card {
           padding: 12px;
         }
       }
    </style>
  </head>
  <body>
         <!-- JavaScript無効時のメッセージ -->
     <noscript>
       <div style="background: #e74c3c; color: white; padding: 20px; text-align: center; margin: 20px; border-radius: 10px;">
         <h2>⚠️ JavaScriptが無効になっています</h2>
         <p>このアプリケーションを正常に動作させるには、JavaScriptを有効にしてください。</p>
         <p>ブラウザの設定でJavaScriptを有効にしてから、ページを再読み込みしてください。</p>
       </div>
     </noscript>
     
     <div class="container">
       <h1>キャンピングカー修理専門AIチャット</h1>
       <p class="subtitle">経験豊富なAIがキャンピングカーの修理について詳しくお答えします</p>

             <!-- 岡山キャンピングカー修理サポートセンター情報 -->
       <div class="support-center-info" id="supportCenter">
         <h2>🏢 岡山キャンピングカー修理サポートセンター</h2>
         <div class="support-details">
                       <div class="info-item">
              <strong>📍 所在地:</strong> 岡山県岡山市北区東古松485-4 2F
            </div>
            <div class="info-item">
              <strong>📞 電話番号:</strong> 086-206-6622
            </div>
            <div class="info-item">
              <strong>📧 お問い合わせ:</strong> 
              <a href="https://camper-repair.net/contact/" target="_blank" class="contact-form-btn">
                📝 お問い合わせフォーム
              </a>
            </div>
            <div class="info-item">
              <strong>🕒 営業時間:</strong> 年中無休（9:00～21:00）
            </div>
           <div class="info-item">
             <strong>🔧 対応サービス:</strong> キャンピングカー修理・メンテナンス・部品交換・緊急対応
           </div>
           <div class="info-item">
             <strong>🚗 対応車種:</strong> 全メーカーのキャンピングカー・RV車
           </div>
           <div class="info-item">
             <strong>🛠️ 専門分野:</strong> 電気系統・給排水・ガス設備・冷暖房・車体修理
           </div>
           <div class="info-item">
             <strong>🚨 緊急対応:</strong> 24時間緊急修理対応（要事前登録）
           </div>
           <div class="info-item">
             <strong>💳 支払い方法:</strong> 現金・クレジットカード・銀行振込
           </div>
         </div>
       </div>

      <!-- チャットヘッダー -->
      <div class="chat-header">
        <button onclick="startNewConversation()" class="new-chat-btn">🆕 新しい会話を開始</button>
        <div class="chat-info">
          <span>💬 会話型チャットボット</span>
        </div>
      </div>

             <!-- 関連ブログセクション -->
       <div id="relatedBlogs" class="related-blogs">
         <h3>📝 関連ブログ記事</h3>
         <div id="blogGrid" class="blog-grid">
           <!-- ブログ記事がここに表示されます -->
         </div>
       </div>

       <!-- チャットエリア -->
       <div class="chat-container">
         <div id="chatMessages" class="chat-messages">
           <!-- メッセージがここに表示されます -->
         </div>
        
        <!-- 入力エリア -->
        <div class="chat-input-area">
          <form id="questionForm" class="chat-form">
            <div class="input-group">
              <input
                type="text"
                id="question"
                name="question"
                placeholder="キャンピングカーの修理について質問してください..."
                required
                class="chat-input"
              />
              <button type="submit" class="send-btn">📤</button>
            </div>
          </form>
          
          <!-- クイック質問ボタン -->
          <div class="quick-questions">
            <button onclick="setQuestion('エンジンが始動しない場合の対処法を教えてください')" class="quick-btn">エンジンが始動しない</button>
            <button onclick="setQuestion('給排水システムの故障時の修理方法は？')" class="quick-btn">給排水システム</button>
            <button onclick="setQuestion('電気系統のトラブルシューティング方法')" class="quick-btn">電気系統</button>
            <button onclick="setQuestion('定期メンテナンスのスケジュールは？')" class="quick-btn">メンテナンス</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      function setQuestion(question) {
        document.getElementById('question').value = question;
        document.getElementById('question').focus();
      }

      // 会話履歴を管理
      let conversationHistory = [];
      
      // オフライン回答機能
      function getOfflineAnswer(question) {
        const questionLower = question.toLowerCase();
        
        if (questionLower.includes('エンジン') || questionLower.includes('始動')) {
          return `【状況確認】
エンジンが始動しない問題ですね。まず、以下の点を確認してください。

【修理アドバイス】
• バッテリーの電圧を確認（12V以上必要）
• 燃料タンクに燃料が残っているか確認
• エンジンオイルの量と状態を確認
• スパークプラグの状態を確認

【追加の質問】
• エンジンは全く反応しませんか？
• キーを回した時の音は聞こえますか？
• 最近のメンテナンス状況は？

【次のステップ】
上記の確認を行った後、結果を教えてください。

【最後に】
詳細な診断が必要な場合は、岡山キャンピングカー修理サポートセンターまでお電話ください。`;
        } else if (questionLower.includes('電気') || questionLower.includes('電装')) {
          return `【状況確認】
電気系統のトラブルですね。どのような症状が現れていますか？

【修理アドバイス】
• ヒューズボックスの確認
• バッテリー端子の接続状態確認
• 配線の断線やショートの確認
• スイッチ類の動作確認

【追加の質問】
• どの部分の電気が使えませんか？
• ヒューズは確認しましたか？
• 最近の工事や改造はありましたか？

【次のステップ】
症状を詳しく教えてください。

【最後に】
電気系統の修理は専門知識が必要です。安全のため、専門店での修理をお勧めします。`;
        } else if (questionLower.includes('水') || questionLower.includes('給排水')) {
          return `【状況確認】
給排水システムの問題ですね。具体的な症状を教えてください。

【修理アドバイス】
• 水道ポンプの動作確認
• 配管の詰まり確認
• タンクの水漏れ確認
• フィルターの清掃

【追加の質問】
• 水が出ない、それとも漏れていますか？
• ポンプの音は聞こえますか？
• 最近の使用状況は？

【次のステップ】
症状を詳しく教えてください。

【最後に】
給排水システムの修理は専門知識が必要です。`;
        } else {
          return `【状況確認】
キャンピングカーの修理についてご相談ですね。

【修理アドバイス】
• 症状を詳しく教えてください
• 安全確認を最優先に行ってください
• 専門知識が必要な場合は専門店に相談

【追加の質問】
• 具体的にどのような問題が発生していますか？
• いつから症状が現れていますか？
• 最近の使用状況は？

【次のステップ】
詳細な症状をお聞かせください。

【最後に】
岡山キャンピングカー修理サポートセンターまでお気軽にご相談ください。`;
        }
      }
      
      // サーバー接続テスト機能
      function testServerConnection() {
        fetch('/ask', {
          method: 'POST',
          body: new URLSearchParams({ question: 'テスト接続' }),
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
        })
        .then(response => {
          console.log('サーバー接続テスト成功:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('サーバー応答:', data);
        })
        .catch(error => {
          console.error('サーバー接続エラー:', error);
          addMessage("⚠️ サーバーとの接続に問題があります。以下の手順で確認してください：\n\n1. AnacondaプロンプトでFlaskアプリケーションが起動しているか確認\n2. ブラウザで http://localhost:5000 にアクセス\n3. エラーメッセージを確認", false);
        });
      }
      
      function startNewConversation() {
        // チャットメッセージをクリア
        document.getElementById('chatMessages').innerHTML = '';
        
        // 会話履歴をリセット
        conversationHistory = [];
        
        // 新しい会話を開始
        fetch('/start_conversation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => {
          console.log('Start conversation response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('新しい会話を開始しました:', data.conversation_id);
          
          // 初期メッセージを表示
          setTimeout(() => {
            addMessage("こんにちは！キャンピングカーの修理について何でもお聞かせください。エンジンの問題、電気系統の故障、給排水の問題など、どんなことでもお気軽にご相談ください。", false);
          }, 500);
        })
        .catch(error => {
          console.error('新しい会話開始エラー:', error);
          addMessage("サーバーとの接続に問題があります。Flaskアプリケーションが起動しているか確認してください。", false);
        });
      }

                   function addMessage(content, isUser = false) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
        
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        // メッセージ内容を処理
        if (isUser) {
          messageContent.textContent = content;
        } else {
          // AIの回答をHTML形式で処理
          let processedContent = content
            .replace(/【状況確認】/g, '<h3 style="color: #27ae60; margin-top: 20px; margin-bottom: 15px; border-bottom: 2px solid #27ae60; padding-bottom: 5px;">💬 状況確認</h3>')
            .replace(/【修理アドバイス】/g, '<h3 style="color: #2c3e50; margin-top: 20px; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 5px;">🔧 修理アドバイス</h3>')
            .replace(/【追加の質問】/g, '<h3 style="color: #f39c12; margin-top: 20px; margin-bottom: 15px; border-bottom: 2px solid #f39c12; padding-bottom: 5px;">❓ 追加の質問</h3>')
            .replace(/【次のステップ】/g, '<h3 style="color: #9b59b6; margin-top: 20px; margin-bottom: 15px; border-bottom: 2px solid #9b59b6; padding-bottom: 5px;">🔄 次のステップ</h3>')
            .replace(/【最後に】/g, '<h3 style="color: #e74c3c; margin-top: 20px; margin-bottom: 15px; border-bottom: 2px solid #e74c3c; padding-bottom: 5px;">📞 サポートセンター</h3>');
          
          // 箇条書きを処理
          const lines = processedContent.split('\n');
          let processedLines = [];
          let inList = false;
          
          for (let line of lines) {
            if (line.trim().startsWith('•')) {
              if (!inList) {
                processedLines.push('<ul style="margin: 10px 0; padding-left: 20px;">');
                inList = true;
              }
              processedLines.push(`<li style="margin-bottom: 8px; padding-left: 10px; position: relative;">${line.trim()}</li>`);
            } else {
              if (inList) {
                processedLines.push('</ul>');
                inList = false;
              }
              processedLines.push(line);
            }
          }
          
          if (inList) {
            processedLines.push('</ul>');
          }
          
          messageContent.innerHTML = processedLines.join('\n');
          
          // フォローアップ質問ボタンを追加（AIの回答の場合のみ）
          if (!isUser && content.includes('【追加の質問】')) {
            const followUpDiv = document.createElement('div');
            followUpDiv.className = 'follow-up-questions';
            followUpDiv.style.marginTop = '15px';
            followUpDiv.style.paddingTop = '15px';
            followUpDiv.style.borderTop = '1px solid #e9ecef';
            
            const followUpTitle = document.createElement('div');
            followUpTitle.style.fontWeight = 'bold';
            followUpTitle.style.marginBottom = '10px';
            followUpTitle.style.color = '#2c3e50';
            followUpTitle.textContent = '💡 関連する質問:';
            
            followUpDiv.appendChild(followUpTitle);
            
            const followUpButtons = [
              'エンジンの状態はどうですか？',
              '電気系統に異常はありますか？',
              '最近のメンテナンス状況は？',
              '他の症状はありますか？'
            ];
            
            followUpButtons.forEach(btnText => {
              const btn = document.createElement('button');
              btn.textContent = btnText;
              btn.className = 'follow-up-btn';
              btn.style.cssText = `
                background: #3498db;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 15px;
                margin: 5px;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.3s ease;
              `;
              btn.onmouseover = () => {
                btn.style.background = '#2980b9';
                btn.style.transform = 'translateY(-1px)';
              };
              btn.onmouseout = () => {
                btn.style.background = '#3498db';
                btn.style.transform = 'translateY(0)';
              };
              btn.onclick = () => {
                document.getElementById('question').value = btnText;
                document.getElementById('questionForm').dispatchEvent(new Event('submit'));
              };
              followUpDiv.appendChild(btn);
            });
            
            messageContent.appendChild(followUpDiv);
          }
        }
        
        const messageTime = document.createElement('div');
        messageTime.className = 'message-time';
        messageTime.textContent = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        
        messageDiv.appendChild(messageContent);
        messageDiv.appendChild(messageTime);
        chatMessages.appendChild(messageDiv);
        
        // スクロールを最下部に
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

       // 関連ブログを表示する関数
       function showRelatedBlogs(blogs) {
         const blogSection = document.getElementById('relatedBlogs');
         const blogGrid = document.getElementById('blogGrid');
         
         if (!blogs || blogs.length === 0) {
           blogSection.style.display = 'none';
           return;
         }
         
         blogGrid.innerHTML = '';
         
         blogs.forEach(blog => {
           const blogCard = document.createElement('div');
           blogCard.className = 'blog-card';
           blogCard.onclick = () => window.open(blog.url, '_blank');
           
           blogCard.innerHTML = `
             <div class="blog-title">${blog.title}</div>
             <div class="blog-excerpt">${blog.excerpt}</div>
             <div class="blog-meta">
               <div class="blog-tags">
                 ${blog.tags.map(tag => `<span class="blog-tag">${tag}</span>`).join('')}
               </div>
               <div>${blog.date}</div>
             </div>
           `;
           
           blogGrid.appendChild(blogCard);
         });
         
         blogSection.style.display = 'block';
       }

               // ブログ検索機能
        function searchRelatedBlogs(query) {
          // シナリオ1-20に基づいたブログデータ
          const sampleBlogs = [
            {
              title: 'サブバッテリーが数時間で空になる原因と対処法',
              excerpt: '走行充電不足、バッテリー劣化、家電の連続使用など、サブバッテリーが早く空になる原因を詳しく解説します。',
              tags: ['サブバッテリー', '充電', '故障'],
              date: '2024-01-15',
              url: '#'
            },
            {
              title: '走行中にサブバッテリーが充電されない問題',
              excerpt: 'アイソレーターやDC-DCコンバーターの故障診断方法と、正常な充電電圧について説明します。',
              tags: ['サブバッテリー', 'アイソレーター', '充電'],
              date: '2024-01-12',
              url: '#'
            },
            {
              title: '水道ポンプが動かない時のトラブルシューティング',
              excerpt: 'ポンプが無音で動作しない場合の原因と、ヒューズ、配線、プレッシャースイッチの確認方法を解説します。',
              tags: ['水道ポンプ', '故障', '配線'],
              date: '2024-01-10',
              url: '#'
            },
            {
              title: '水道ポンプから水が出ない時の対処法',
              excerpt: 'ポンプ音はするのに水が出ない場合の原因と、ストレーナー清掃、エア抜きの方法を紹介します。',
              tags: ['水道ポンプ', 'ストレーナー', '水漏れ'],
              date: '2024-01-08',
              url: '#'
            },
            {
              title: 'ガスコンロの点火スパークが出ない時の修理方法',
              excerpt: '点火プラグの電池交換から配線点検まで、ガスコンロが点火しない原因と対処法を詳しく解説します。',
              tags: ['ガスコンロ', '点火', '電池'],
              date: '2024-01-05',
              url: '#'
            },
            {
              title: 'ガスコンロの火が消える問題の解決法',
              excerpt: 'サーモカップルの感度調整と炎検知装置の位置調整方法について説明します。',
              tags: ['ガスコンロ', 'サーモカップル', '炎検知'],
              date: '2024-01-03',
              url: '#'
            },
            {
              title: 'ソーラーパネルの発電効率低下の原因と対策',
              excerpt: 'パネルの汚れ、配線の断線、コントローラーの故障など、発電効率が悪い原因を解説します。',
              tags: ['ソーラーパネル', '発電', '効率'],
              date: '2023-12-28',
              url: '#'
            },
            {
              title: 'トイレの水漏れと詰まりの修理方法',
              excerpt: 'トイレの水漏れ箇所の特定方法と、詰まりの解消、シール交換の手順を紹介します。',
              tags: ['トイレ', '水漏れ', '詰まり'],
              date: '2023-12-25',
              url: '#'
            },
            {
              title: '電装系のトラブル診断と修理ガイド',
              excerpt: 'ヒューズ切れ、配線断線、スイッチ故障など、電装系の一般的な問題と解決方法を解説します。',
              tags: ['電装系', 'ヒューズ', '配線'],
              date: '2023-12-20',
              url: '#'
            },
            {
              title: 'ルーフベント・換気扇の故障とメンテナンス',
              excerpt: '換気扇の動作不良、異音、水漏れなどの問題と、定期的なメンテナンス方法を説明します。',
              tags: ['ルーフベント', '換気扇', 'メンテナンス'],
              date: '2023-12-18',
              url: '#'
            },
            {
              title: '家具の破損修理と補強方法',
              excerpt: 'テーブル、ベッド、収納の破損箇所の修理方法と、耐久性を向上させる補強テクニックを紹介します。',
              tags: ['家具', '修理', '補強'],
              date: '2023-12-15',
              url: '#'
            },
            {
              title: '外部電源の接続トラブルと解決法',
              excerpt: '外部電源からの充電ができない場合の原因と、配線、コネクター、充電器の点検方法を解説します。',
              tags: ['外部電源', '充電', '配線'],
              date: '2023-12-12',
              url: '#'
            },
            {
              title: '雨漏りの原因特定と修理方法',
              excerpt: '天井、窓周り、配管からの雨漏りの原因特定と、シーリング材による修理方法を説明します。',
              tags: ['雨漏り', 'シーリング', '修理'],
              date: '2023-12-10',
              url: '#'
            },
            {
              title: 'FFヒーターの故障診断と修理ガイド',
              excerpt: 'FFヒーターが動作しない原因と、温風が出ない、異音がするなどの問題の解決方法を解説します。',
              tags: ['FFヒーター', '故障', '温風'],
              date: '2023-12-08',
              url: '#'
            },
            {
              title: 'インバーターの故障と交換時期',
              excerpt: 'インバーターの動作不良、過熱、出力電圧異常などの症状と対処法について詳しく説明します。',
              tags: ['インバーター', '故障', '電圧'],
              date: '2023-12-05',
              url: '#'
            },
            {
              title: '室内LED照明の故障と交換方法',
              excerpt: 'LED照明の点灯不良、ちらつき、明度低下などの問題と、適切な交換方法を紹介します。',
              tags: ['LED照明', '故障', '交換'],
              date: '2023-12-03',
              url: '#'
            },
            {
              title: '排水タンクの詰まりと清掃方法',
              excerpt: '排水タンクの詰まり原因と、定期的な清掃、防臭対策について詳しく解説します。',
              tags: ['排水タンク', '詰まり', '清掃'],
              date: '2023-11-30',
              url: '#'
            },
            {
              title: 'ウインドウの水漏れとシール交換',
              excerpt: 'ウインドウ周りの水漏れ修理と、ゴムシールの交換方法について説明します。',
              tags: ['ウインドウ', '水漏れ', 'シール'],
              date: '2023-11-28',
              url: '#'
            },
            {
              title: '車体外装の破損修理と補修方法',
              excerpt: '車体の傷、へこみ、クラックの修理方法と、塗装補修の手順を詳しく解説します。',
              tags: ['車体外装', '破損', '塗装'],
              date: '2023-11-25',
              url: '#'
            },
            {
              title: 'キャンピングカーの異音診断と対策',
              excerpt: '走行中の異音、振動、きしみ音の原因特定と、適切な対処方法を紹介します。',
              tags: ['異音', '振動', '診断'],
              date: '2023-11-22',
              url: '#'
            },
            {
              title: '冷蔵庫の故障とメンテナンス方法',
              excerpt: '冷蔵庫の冷却不良、霜付き、異音などの問題と、定期的なメンテナンス方法を説明します。',
              tags: ['冷蔵庫', '冷却', 'メンテナンス'],
              date: '2023-11-20',
              url: '#'
            }
          ];
         
         // クエリに基づいて関連ブログをフィルタリング
         const relatedBlogs = sampleBlogs.filter(blog => {
           const searchTerms = query.toLowerCase().split(' ');
           const blogText = (blog.title + ' ' + blog.excerpt + ' ' + blog.tags.join(' ')).toLowerCase();
           
           return searchTerms.some(term => blogText.includes(term));
         });
         
         showRelatedBlogs(relatedBlogs);
       }



      document.getElementById("questionForm").addEventListener("submit", function (event) {
        event.preventDefault();

        const question = document.getElementById("question").value;
        if (!question.trim()) return;

                         // ユーザーメッセージを追加
        addMessage(question, true);
        
        // 会話履歴に追加
        conversationHistory.push({ role: 'user', content: question });
        
        // 関連ブログを検索して表示
        searchRelatedBlogs(question);
        
        // 入力欄をクリア
        document.getElementById("question").value = "";

        // ローディングメッセージを追加
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'message ai';
        loadingDiv.innerHTML = `
          <div class="message-content">
            <div class="loading">🔧 修理アドバイスを生成中...</div>
          </div>
        `;
        document.getElementById('chatMessages').appendChild(loadingDiv);
        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;

        fetch("/ask", {
          method: "POST",
          body: new URLSearchParams({ question: question }),
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
        })
          .then((response) => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            console.log('Response data:', data);
            // ローディングメッセージを削除
            const loadingMessages = document.querySelectorAll('.message.ai .loading');
            loadingMessages.forEach(msg => msg.parentElement.parentElement.remove());
            
            // AIの回答を追加
            const aiAnswer = data.answer || "回答がありませんでした。";
            addMessage(aiAnswer, false);
            
            // 会話履歴にAIの回答を追加
            conversationHistory.push({ role: 'assistant', content: aiAnswer });
          })
          .catch((error) => {
            console.error("Error:", error);
            // ローディングメッセージを削除
            const loadingMessages = document.querySelectorAll('.message.ai .loading');
            loadingMessages.forEach(msg => msg.parentElement.parentElement.remove());
            
            // オフライン機能として基本的な回答を提供
            const offlineAnswer = getOfflineAnswer(question);
            addMessage(offlineAnswer, false);
          });
      });

      // Enterキーで送信
      document.getElementById('question').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          document.getElementById('questionForm').dispatchEvent(new Event('submit'));
        }
      });

      // ページ読み込み時に新しい会話を開始
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded イベントが発火しました');
        
        try {
          // 新しい会話を開始
          startNewConversation();
          console.log('startNewConversation が実行されました');
          
          // 初期メッセージを表示
          setTimeout(() => {
            addMessage("こんにちは！キャンピングカーの修理について何でもお聞かせください。エンジンの問題、電気系統の故障、給排水の問題など、どんなことでもお気軽にご相談ください。", false);
          }, 500);
          
          // サーバー接続テスト
          setTimeout(() => {
            testServerConnection();
          }, 1000);
          
          // デバッグ用：サポートセンター情報とブログ機能の確認
          const supportElement = document.querySelector('.support-center-info');
          const blogElement = document.getElementById('relatedBlogs');
          const supportById = document.getElementById('supportCenter');
          
          console.log('サポートセンター情報要素:', supportElement);
          console.log('関連ブログ要素:', blogElement);
          console.log('サポートセンター情報要素（ID）:', supportById);
          
          // ページ全体のHTML構造を確認
          console.log('ページのHTML構造:', document.body.innerHTML.substring(0, 500));
          
          if (supportElement) {
            console.log('サポートセンター情報が表示されています');
          } else {
            console.log('サポートセンター情報が見つかりません');
          }
          
          if (blogElement) {
            console.log('関連ブログ要素が見つかりました');
          } else {
            console.log('関連ブログ要素が見つかりません');
          }
          
          // テスト用：サンプルブログを表示
          setTimeout(() => {
            console.log('テストブログを表示します');
            const testBlogs = [
              {
                title: 'テストブログ記事',
                excerpt: 'これはテスト用のブログ記事です。',
                tags: ['テスト'],
                date: '2024-01-01',
                url: '#'
              }
            ];
            showRelatedBlogs(testBlogs);
            console.log('showRelatedBlogs が実行されました');
          }, 1000);
          
        } catch (error) {
          console.error('エラーが発生しました:', error);
        }
      });
      
             // ページ読み込み前のデバッグ
       console.log('スクリプトが読み込まれました');
       
       // 関数の存在確認
       console.log('showRelatedBlogs 関数:', typeof showRelatedBlogs);
       console.log('searchRelatedBlogs 関数:', typeof searchRelatedBlogs);
       
       // JavaScript有効性テスト
       function testJavaScript() {
         console.log('✅ JavaScriptが正常に動作しています');
         alert('JavaScriptが有効です！');
         return true;
       }
       
               // ページ読み込み時にJavaScriptテストを実行
        if (typeof testJavaScript === 'function') {
          console.log('✅ JavaScript関数が定義されています');
        } else {
          console.log('❌ JavaScript関数が定義されていません');
        }
        
        // 即座にテストを実行
        console.log('=== JavaScript テスト開始 ===');
        testJavaScript();
        
        // 要素の存在確認
        setTimeout(() => {
          console.log('=== 要素確認テスト ===');
          const supportElement = document.querySelector('.support-center-info');
          const blogElement = document.getElementById('relatedBlogs');
          
          console.log('サポートセンター要素:', supportElement);
          console.log('ブログ要素:', blogElement);
          
          if (supportElement) {
            console.log('✅ サポートセンター情報が表示されています');
            supportElement.style.border = '3px solid red';
          } else {
            console.log('❌ サポートセンター情報が見つかりません');
          }
          
          if (blogElement) {
            console.log('✅ ブログ要素が見つかりました');
            blogElement.style.border = '3px solid blue';
          } else {
            console.log('❌ ブログ要素が見つかりません');
          }
        }, 100);
    </script>
  </body>
</html>